<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>CEO - Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Segoe UI,Arial;margin:0;background:#f4ecd6;color:#333}
    .wrap{max-width:1100px;margin:18px auto;padding:18px}
    .card{background:#fffdf8;border-radius:10px;padding:14px;margin-bottom:12px;border:1px solid #e6dcc0}
    .row{display:flex;gap:10px;align-items:center}
    input,select,button,textarea{padding:8px;border-radius:8px;border:1px solid #ccc}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
    th{background:#e9d8a6}
    .btn{background:#996600;color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
    
    .topbar {
      display: flex;
      align-items: center;
      justify-content: center;
      background: #996600;
      color: #fff;
      padding: 12px 16px;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    }
    .topbar h2 { margin: 0; font-size: 16px; font-weight: 700; letter-spacing: 0.5px; }
    h3 { font-size: 15px; font-weight: 700; margin: 8px 0; color: #663300; }
    .btn-back {
      position: absolute;
      left: 13px;
      background: transparent;
      color: #fff;
      border: none;
      font-size: 15px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .btn-back:hover { opacity: 0.8; }
    .table-wrapper { width: 100%; overflow-x: auto; }
    .table-wrapper table { width: 100%; min-width: 700px; }
    .form-grid {
      display: grid;
      grid-template-columns: 160px 1fr;
      align-items: center;
      gap: 8px 10px;
    }

  .notice-preview {
  margin: 15px 0;
  padding: 12px 20px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
}
.notice-preview.info { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
.notice-preview.warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
.notice-preview.error { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
.notice-preview.success { background: linear-gradient(135deg, #10b981, #059669); color: white; }
.notice-preview .icon { font-size: 20px; }

.toggle-switch {
  position: relative;
  display: inline-block;
  width: 50px;
  height: 24px;
}
.toggle-switch input {
  opacity: 0;
  width: 0;
  height: 0;
}
.toggle-slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .3s;
  border-radius: 24px;
}
.toggle-slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  transition: .3s;
  border-radius: 50%;
}
input:checked + .toggle-slider {
  background-color: #2e7d32;
}
input:checked + .toggle-slider:before {
  transform: translateX(26px);
}
    .current-rate {
      font-size: 20px;
      color: #996600;
      font-weight: bold;
      margin: 10px 0;
    }
    .rate-history {
      max-height: 300px;
      overflow-y: auto;
      margin-top: 10px;
    }
    .rate-item {
      padding: 10px;
      background: #f9f9f9;
      margin: 5px 0;
      border-radius: 6px;
      border-left: 3px solid #14b47e;
    }
    .success-msg {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
    }
    .error-msg {
      background: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
    }
    @media (max-width: 720px) {
      table th, table td { font-size: 13px; padding: 6px; }
      h3 { font-size: 15px; }
      .btn-back { font-size: 15px; }
      input, select, button { font-size: 13px; padding: 6px; }
    }
    @media (max-width: 600px) {
      .form-grid { grid-template-columns: 1fr; }
    }

  </style>
</head>
<body>
  <div class="topbar">
    <button class="btn-back" onclick="window.location.href='index.html'">‚Üê Home</button>
    <h2>Admin Panel</h2>
  </div>
  
  <div class="wrap">
    <div class="card">
      <h3>Admin Login üîê üõ†Ô∏è </h3>
      <p>Enter your admin token (keeps in session only):</p>
      <div class="row">
        <input id="admToken" placeholder="admin token" style="flex:1" />
        <button id="btnLogin" class="btn">Login</button>
        <button id="btnLogout" style="display:none" class="btn">Logout</button>
      </div>
      <p id="loginMsg" style="color:#a00"></p>
    </div>
    
  <!-- Maintenance Notice Management Card -->
<div class="card" id="maintenanceSection" style="display:none">
  <h3>üîî Maintenance Notice Management</h3>
  
  <div style="margin-bottom: 20px;">
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 15px;">
      <strong>Notice Status:</strong>
      <label class="toggle-switch">
        <input type="checkbox" id="noticeEnabled">
        <span class="toggle-slider"></span>
      </label>
      <span id="noticeStatusText" style="color: #666;">Disabled</span>
    </div>
  </div>

  <div class="form-grid" style="max-width: 600px;">
    <label for="noticeType">Notice Type:</label>
    <select id="noticeType">
      <option value="info">Info (Blue)</option>
      <option value="warning">Warning (Orange)</option>
      <option value="error">Error (Red)</option>
      <option value="success">Success (Green)</option>
    </select>

    <label for="noticeIcon">Icon:</label>
    <input type="text" id="noticeIcon" placeholder="üîß" maxlength="2" style="width: 80px;" />

    <label for="noticeTitle">Title:</label>
    <input type="text" id="noticeTitle" placeholder="Scheduled Maintenance" />

    <label for="noticeMessage">Message:</label>
    <textarea id="noticeMessage" placeholder="System will be under maintenance..."></textarea>

    <div></div>
    <button id="btnUpdateNotice" class="btn">üíæ Save Notice Settings</button>
  </div>

  <div id="noticeUpdateMsg"></div>

  <div style="margin-top: 20px;">
    <strong>Preview:</strong>
    <div id="noticePreview" class="notice-preview info">
      <span class="icon">üîß</span>
      <div>
        <strong>Scheduled Maintenance</strong><br>
        <span>System will be under maintenance...</span>
      </div>
    </div>
  </div>
</div>

    <!-- ‚úÖ NEW: Exchange Rate Section -->
    <div class="card" id="exchangeRateSection" style="display:none">
      <h3>üí∞ Pi Exchange Rate Management</h3>
      
      <div style="margin-bottom: 20px;">
        <strong>Current Rate:</strong>
        <div id="currentRate" class="current-rate">Loading...</div>
        <button onclick="loadExchangeRate()" class="btn" style="background:#176cb0;">üîÑ Refresh</button>
      </div>

      <div class="form-grid" style="max-width: 500px;">
        <label for="newExchangeRate">New Rate (1 Pi = X MYR):</label>
        <input type="number" id="newExchangeRate" placeholder="1.00" step="0.01" min="0.01" />
        <div></div>
        <button id="btnUpdateRate" class="btn">üíæ Update Rate</button>
      </div>
      <div id="rateUpdateMsg"></div>

      <details style="margin-top: 20px;">
        <summary style="cursor: pointer; font-weight: 600; margin-bottom: 10px;">üìú View Rate History</summary>
        <div id="rateHistory" class="rate-history">Loading...</div>
      </details>
    </div>

    <div class="card" id="adminPanel" style="display:none">
      <h3>Orders (Latest)</h3>
      <div class="row" style="margin-bottom:8px">
        <input id="filterPhone" placeholder="Filter by phone (optional)"/>
        <button id="btnLoad" class="btn">Load</button>
      </div>
      <div class="table-wrapper"><div id="ordersHolder"></div></div>
      <div style="text-align:center;margin:10px;">
        <button id="loadMoreBtn" class="btn" style="display:none;" onclick="loadOrders()">Load More</button>
      </div>
    </div>

<div class="card" id="updateProductSection" style="display:none">
  <h3>Update Product</h3>

  <div class="form-grid">
    <label for="prodSelect">Product:</label>
    <select id="prodSelect">
      <option value="">-- Select Product --</option>
    </select>

    <label for="currPrice">Current Price:</label>
    <input type="number" id="currPrice" step="0.01" readonly />

    <label for="currStock">Current Stock:</label>
    <input type="number" id="currStock" readonly />

    <label for="newPrice">New Price (optional):</label>
    <input type="number" id="newPrice" step="0.01" placeholder="Enter new price" />

    <label for="newStock">New Stock (optional):</label>
    <input type="number" id="newStock" placeholder="Enter new stock" />

    <button id="btnUpdateProduct" class="btn">Update Product</button>
  </div>

  <div id="updateResult" style="margin-top:8px;font-size:13px"></div>
</div>

  </div>

<script>
  // GLOBAL token helpers
  function token(){ return sessionStorage.getItem('ADMIN_TOKEN') || ''; }
  function setToken(t){ sessionStorage.setItem('ADMIN_TOKEN', t); }
  function clearToken(){ sessionStorage.removeItem('ADMIN_TOKEN'); }

  const MAINTENANCE_API = '/api/admin/maintenance-notice';
  
  // Maintenance DOM refs
  let noticeEnabled;
  let noticeStatusText;
  let noticeType;
  let noticeIcon;
  let noticeTitle;
  let noticeMessage;
  let noticePreview;
  let btnUpdateNotice;
  let noticeUpdateMsg;

  document.addEventListener('DOMContentLoaded', () => {
    const ORDERS_API = '/api/admin/orders';
    const PRODUCTS_API = '/api/admin/products';
    const EXCHANGE_RATE_API = '/api/admin/exchange-rate';
    
    // Get maintenance elements
    noticeEnabled     = document.getElementById('noticeEnabled');
    noticeStatusText  = document.getElementById('noticeStatusText');
    noticeType        = document.getElementById('noticeType');
    noticeIcon        = document.getElementById('noticeIcon');
    noticeTitle       = document.getElementById('noticeTitle');
    noticeMessage     = document.getElementById('noticeMessage');
    noticePreview     = document.getElementById('noticePreview');
    btnUpdateNotice   = document.getElementById('btnUpdateNotice');
    noticeUpdateMsg   = document.getElementById('noticeUpdateMsg');

    // Bind maintenance listeners
    noticeEnabled.addEventListener('change', () => {
      noticeStatusText.textContent = noticeEnabled.checked ? 'Active' : 'Disabled';
      noticeStatusText.style.color = noticeEnabled.checked ? '#2e7d32' : '#666';
    });
    
    [noticeType, noticeIcon, noticeTitle, noticeMessage].forEach(el => {
      el.addEventListener('input', updateNoticePreview);
    });
    
    btnUpdateNotice.addEventListener('click', saveMaintenanceNotice);
    
    // Other elements
    const maintenanceSection = document.getElementById('maintenanceSection');
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const admTokenInput = document.getElementById('admToken');
    const loginMsg = document.getElementById('loginMsg');
    const adminPanel = document.getElementById('adminPanel');
    const updateProductSection = document.getElementById('updateProductSection');
    const exchangeRateSection = document.getElementById('exchangeRateSection');
    const btnLoad = document.getElementById('btnLoad');
    const ordersHolder = document.getElementById('ordersHolder');
    const filterPhone = document.getElementById('filterPhone');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const prodSelect = document.getElementById('prodSelect');
    const currPrice = document.getElementById('currPrice');
    const currStock = document.getElementById('currStock');
    const newPrice = document.getElementById('newPrice');
    const newStock = document.getElementById('newStock');
    const btnUpdateProduct = document.getElementById('btnUpdateProduct');
    const updateResult = document.getElementById('updateResult');
    const currentRate = document.getElementById('currentRate');
    const newExchangeRate = document.getElementById('newExchangeRate');
    const btnUpdateRate = document.getElementById('btnUpdateRate');
    const rateUpdateMsg = document.getElementById('rateUpdateMsg');
    const rateHistory = document.getElementById('rateHistory');

    let orderOffset = 0;
    const ORDERS_LIMIT = 10;

    // Show admin panel
    function showPanel(){
  console.log('showPanel() called');
  console.log('maintenanceSection element:', maintenanceSection);
      maintenanceSection.style.display = 'block'; // ‚úÖ ADD THIS LINE!
      adminPanel.style.display = 'block';
      updateProductSection.style.display = 'block';
      exchangeRateSection.style.display = 'block';
      
      btnLogout.style.display = 'inline-block';
      btnLogin.style.display = 'none';
      admTokenInput.style.display = 'none';
      loginMsg.textContent = '';
  console.log('maintenanceSection display after setting:', maintenanceSection.style.display);
      orderOffset = 0;
      loadOrders(true);
      loadProducts();
      loadExchangeRate();
      loadRateHistory();
  console.log('About to call loadMaintenanceNotice()');
      loadMaintenanceNotice(); // ‚úÖ KEEP THIS TOO
    }

    // Login validation
    async function validateTokenAndShow(t) {
      try {
        const r = await fetch(ORDERS_API, { headers: { 'x-admin-token': t }});
        if (r.status === 403) throw new Error('Unauthorized');
        await r.json();
        setToken(t);
        showPanel();
      } catch (err) {
        console.error('Token validation failed', err);
        loginMsg.textContent = 'Invalid token or server error';
        loginMsg.style.color = '#a00';
      }
    }

    // Login/logout
    btnLogin.addEventListener('click', () => {
      const v = admTokenInput.value.trim();
      if (!v) { alert('Enter token'); return; }
      validateTokenAndShow(v);
    });

    btnLogout.addEventListener('click', () => {
      clearToken();
      location.reload();
    });

    btnLoad.addEventListener('click', () => {
      orderOffset = 0;
      loadOrders(true);
    });

    loadMoreBtn.addEventListener('click', () => {
      loadOrders(false);
    });

    // Exchange rate functions
    window.loadExchangeRate = async function() {
      currentRate.innerHTML = 'Loading...';
      try {
        const res = await fetch(EXCHANGE_RATE_API, {
          headers: { 'x-admin-token': token() }
        });
        
        if (res.status === 403) {
          currentRate.innerHTML = '<span style="color:#c62828">Unauthorized</span>';
          return;
        }

        const data = await res.json();
        
        if (data.success) {
          currentRate.innerHTML = `
            1 Pi = RM ${data.rate}<br>
            <small style="color:#666;font-weight:normal;">
              (1 MYR = œÄ ${data.pi_per_myr})<br>
              Updated: ${new Date(data.updated_at).toLocaleString()}
            </small>
          `;
        } else {
          currentRate.innerHTML = `<span style="color:#c62828">${data.error}</span>`;
        }
      } catch (err) {
        console.error('Load rate error:', err);
        currentRate.innerHTML = '<span style="color:#c62828">Failed to load</span>';
      }
    };

    async function loadRateHistory() {
      try {
        const res = await fetch(EXCHANGE_RATE_API, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-token': token()
          },
          body: JSON.stringify({ action: 'history', limit: 20 })
        });

        if (res.status === 403) {
          rateHistory.innerHTML = 'Unauthorized';
          return;
        }

        const data = await res.json();
        
        if (data.success && data.history && data.history.length > 0) {
          rateHistory.innerHTML = data.history.map(r => `
            <div class="rate-item">
              <strong>1 Pi = RM ${r.rate}</strong>
              <span style="color:#666;"> (1 MYR = œÄ ${r.pi_per_myr})</span><br>
              <small style="color:#999;">${new Date(r.updated_at).toLocaleString()}</small>
            </div>
          `).join('');
        } else {
          rateHistory.innerHTML = 'No history available';
        }
      } catch (err) {
        console.error('Load history error:', err);
        rateHistory.innerHTML = 'Failed to load history';
      }
    }

    btnUpdateRate && btnUpdateRate.addEventListener('click', async () => {
      const rate = parseFloat(newExchangeRate.value);
      
      if (!rate || rate <= 0) {
        rateUpdateMsg.innerHTML = '<div class="error-msg">Please enter a valid rate</div>';
        return;
      }

      const confirmed = confirm(
        `Update exchange rate to:\n\n` +
        `1 Pi = RM ${rate}\n` +
        `1 MYR = œÄ ${(1/rate).toFixed(8)}\n\n` +
        `This will affect all new orders. Continue?`
      );
      
      if (!confirmed) return;

      btnUpdateRate.disabled = true;
      btnUpdateRate.textContent = 'Updating...';

      try {
        const res = await fetch(EXCHANGE_RATE_API, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-token': token()
          },
          body: JSON.stringify({ action: 'update', rate: rate })
        });

        if (res.status === 403) {
          rateUpdateMsg.innerHTML = '<div class="error-msg">Unauthorized</div>';
          return;
        }

        const data = await res.json();
        
        if (data.success) {
          rateUpdateMsg.innerHTML = `
            <div class="success-msg">
              ‚úÖ ${data.message}<br>
              Old: ${data.old_rate || 'N/A'} ‚Üí New: ${data.new_rate}
            </div>
          `;
          newExchangeRate.value = '';
          loadExchangeRate();
          loadRateHistory();
          setTimeout(() => rateUpdateMsg.innerHTML = '', 5000);
        } else {
          rateUpdateMsg.innerHTML = `<div class="error-msg">Error: ${data.error}</div>`;
        }
      } catch (err) {
        console.error('Update rate error:', err);
        rateUpdateMsg.innerHTML = '<div class="error-msg">Failed to update rate</div>';
      } finally {
        btnUpdateRate.disabled = false;
        btnUpdateRate.textContent = 'üíæ Update Rate';
      }
    });

    // Orders functions
    async function loadOrders(reset = false){
      const phone = filterPhone.value.trim();
      const hdrs = { 'x-admin-token': token() };

      if (reset) orderOffset = 0;

      const q = phone 
        ? `?phone=${encodeURIComponent(phone)}&limit=${ORDERS_LIMIT}&offset=${orderOffset}`
        : `?limit=${ORDERS_LIMIT}&offset=${orderOffset}`;

      try {
        const res = await fetch(ORDERS_API + q, { headers: hdrs });
        if (res.status === 403) { 
          alert('Unauthorized - please login again'); 
          clearToken(); 
          return; 
        }

        const orders = await res.json();
        
        if (reset) {
          renderOrders(orders, true);
        } else {
          renderOrders(orders, false);
        }

        if (orders.length >= ORDERS_LIMIT) {
          loadMoreBtn.style.display = 'inline-block';
        } else {
          loadMoreBtn.style.display = 'none';
        }

        orderOffset += orders.length;
      } catch (err) {
        console.error('Load orders error:', err);
        ordersHolder.innerHTML = '<p style="color:#a00">Failed to load orders</p>';
      }
    }

    function renderOrders(orders, replace = true){
      if(!orders || orders.length === 0) { 
        if (replace) {
          ordersHolder.innerHTML = '<p>No orders found</p>'; 
        }
        return; 
      }

      let html = '';
      if (replace) {
        html = '<table id="ordersTable"><thead><tr><th>Order</th><th>Products</th><th>Total</th><th>Phone</th><th>Status</th><th>Action</th></tr></thead><tbody>';
      }

      orders.forEach(o => {
        const safeProd = (o.prod_name || '').replace(/,/g, '<br/>');
        const oid = o.order_id;

        html += `
          <tr>
            <td>
              <strong>${oid}</strong><br/>
              <small>${o.created_at || ''}</small>
            </td>
            <td style="max-width:300px">${safeProd}</td>
            <td>RM ${parseFloat(o.total_amt || 0).toFixed(2)}</td>
            <td>${o.phone || ''}</td>
            <td id="status-${oid}">
              ${o.order_status || o.pymt_status || '‚Äî'}
            </td>
            <td>
              <label for="s-${oid}" class="sr-only">Order Status</label>
              <select id="s-${oid}" name="status">
                <option value="Pending Payment">Pending Payment</option>
                <option value="Paid">Paid</option>
                <option value="Shipped">Shipped</option>
                <option value="Completed">Completed</option>
                <option value="Cancelled">Cancelled</option>
              </select>
              <br/>
              <label for="courier-${oid}" class="sr-only">Courier Name</label>
              <input
                id="courier-${oid}"
                name="courier_name"
                placeholder="Courier"
                style="width:140px;margin-top:6px"
                value="${o.courier_name || ''}"
              />
              <label for="track-${oid}" class="sr-only">Tracking Link</label>
              <input
                id="track-${oid}"
                name="tracking_link"
                placeholder="Tracking link"
                style="width:220px;margin-top:6px"
                value="${o.tracking_link || ''}"
              />
              <br/>
              <button
                type="button"
                class="btn"
                data-order="${oid}">
                Save
              </button>
            </td>
          </tr>
        `;
      });

      if (replace) {
        html += '</tbody></table>';
        ordersHolder.innerHTML = html;
      } else {
        const tbody = document.querySelector('#ordersTable tbody');
        if (tbody) {
          tbody.insertAdjacentHTML('beforeend', html);
        }
      }

      orders.forEach(o=>{
        const sel = document.getElementById('s-'+o.order_id);
        if(sel && (o.order_status || o.pymt_status)) {
          try { sel.value = o.order_status || o.pymt_status; } catch(e){}
        }
        const btn = document.querySelector(`button[data-order="${o.order_id}"]`);
        if(btn) btn.addEventListener('click', () => updateOrder(o.order_id));
      });
    }

    async function updateOrder(order_id){
      const status = document.getElementById('s-'+order_id).value;
      const courier = document.getElementById('courier-'+order_id).value;
      const track = document.getElementById('track-'+order_id).value;
      const body = { order_id, order_status: status, courier_name: courier, tracking_link: track };
      try {
        const res = await fetch(ORDERS_API + '/' + encodeURIComponent(order_id), {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'x-admin-token': token() },
          body: JSON.stringify(body)
        });
        if (res.status === 403) { alert('Unauthorized'); clearToken(); return; }
        const data = await res.json();
        if (data.success || data.result) {
          document.getElementById('status-'+order_id).textContent = status;
          alert('Order updated');
        } else {
          alert('Update failed: ' + (data.error || JSON.stringify(data)));
        }
      } catch (err) {
        console.error('Update order failed', err);
        alert('Failed to update order (see console)');
      }
    }

    // Products
    async function loadProducts() {
      try {
        const res = await fetch(PRODUCTS_API, { headers: { 'x-admin-token': token() }});
        if (res.status === 403) { console.warn('Unauthorized loading products'); return; }
        const products = await res.json();
        if (!Array.isArray(products)) { console.error('Products response not array', products); return; }
        if (!prodSelect) return;
        prodSelect.innerHTML = '<option value="">‚Äî Select Product ‚Äî</option>';
        products.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.prod_id;
          opt.textContent = `${p.prod_id} ‚Äî ${p.prod_name}`;
          prodSelect.appendChild(opt);
        });
      } catch (err) {
        console.error('Error loading products:', err);
      }
    }

    prodSelect && prodSelect.addEventListener('change', async () => {
      const id = prodSelect.value;
      if (!id) {
        currPrice.value = '';
        currStock.value = '';
        newPrice.value = '';
        newStock.value = '';
        return;
      }
      try {
        const res = await fetch(`${PRODUCTS_API}/${encodeURIComponent(id)}`, {
          headers: { 'x-admin-token': token() }
        });
        if (res.status === 403) { alert('Unauthorized'); return; }
        const data = await res.json();
        if (!data || !data.prod_id) {
          alert('Product not found');
          return;
        }
        currPrice.value = data.price ?? '';
        currStock.value = data.stock ?? '';
        newPrice.value = '';
        newStock.value = '';
      } catch (err) {
        console.error('Error fetching product detail:', err);
      }
    });

    btnUpdateProduct && btnUpdateProduct.addEventListener('click', async () => {
      const prodId = prodSelect.value;
      if (!prodId) { alert('Select a product first'); return; }
      const body = {};
      if (newPrice.value.trim() !== '') body.price = parseFloat(newPrice.value);
      if (newStock.value.trim() !== '') body.stock = parseInt(newStock.value, 10);
      if (Object.keys(body).length === 0) { alert('Enter new price and/or new stock'); return; }

      try {
        const res = await fetch(`${PRODUCTS_API}/${encodeURIComponent(prodId)}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'x-admin-token': token()
          },
          body: JSON.stringify(body)
        });
        if (res.status === 403) { alert('Unauthorized'); clearToken(); return; }
        const data = await res.json();
        if (data.success) {
          updateResult.textContent = `‚úÖ ${prodId} updated successfully`;
          updateResult.style.color = '#006600';
          if (body.price !== undefined) currPrice.value = parseFloat(body.price).toFixed(2);
          if (body.stock !== undefined) currStock.value = body.stock;
        } else {
          updateResult.textContent = '‚ùå Update failed: ' + (data.error || 'Unknown');
          updateResult.style.color = '#a00';
        }
      } catch (err) {
        console.error('Error updating product:', err);
        updateResult.textContent = '‚ùå Update failed (see console)';
        updateResult.style.color = '#a00';
      }
    });

    // Auto show panel if already logged in
    if (sessionStorage.getItem('ADMIN_TOKEN')) {
      showPanel();
    }
  });

  // Maintenance notice functions (outside DOMContentLoaded)
  async function loadMaintenanceNotice() {
  console.log('loadMaintenanceNotice() called');
  console.log('noticeEnabled element:', noticeEnabled);
  console.log('MAINTENANCE_API:', MAINTENANCE_API);
    try {
      const res = await fetch(MAINTENANCE_API, {
        headers: { 'x-admin-token': token() }
      });
  console.log('API response status:', res.status);
      if (res.status === 403) {
        console.error('Unauthorized to load maintenance notice');
        return;
      }

      const data = await res.json();
  console.log('API response data:', data);
      if (data.success) {
        const notice = data.notice || {};
        noticeEnabled.checked = notice.enabled || false;
        noticeStatusText.textContent = notice.enabled ? 'Active' : 'Disabled';
        noticeStatusText.style.color = notice.enabled ? '#2e7d32' : '#666';
        noticeType.value = notice.type || 'info';
        noticeIcon.value = notice.icon || 'üîß';
        noticeTitle.value = notice.title || '';
        noticeMessage.value = notice.message || '';
        updateNoticePreview();
      }
    } catch (err) {
      console.error('Load maintenance notice error:', err);
    }
  }

  function updateNoticePreview() {
    const type = noticeType.value;
    const icon = noticeIcon.value || 'üîß';
    const title = noticeTitle.value || 'Title';
    const message = noticeMessage.value || 'Message';
    
    noticePreview.className = `notice-preview ${type}`;
    noticePreview.innerHTML = `
      <span class="icon">${icon}</span>
      <div>
        <strong>${title}</strong><br>
        <span>${message}</span>
      </div>
    `;
  }

  async function saveMaintenanceNotice() {
    const data = {
      enabled: noticeEnabled.checked,
      type: noticeType.value,
      icon: noticeIcon.value || 'üîß',
      title: noticeTitle.value.trim() || 'Notice',
      message: noticeMessage.value.trim() || 'Please check back later.'
    };

    if (!data.message) {
      noticeUpdateMsg.innerHTML = '<div class="error-msg">Please enter a message</div>';
      return;
    }

    btnUpdateNotice.disabled = true;
    btnUpdateNotice.textContent = 'Saving...';

    try {
      const res = await fetch(MAINTENANCE_API, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'x-admin-token': token()
        },
        body: JSON.stringify(data)
      });

      if (res.status === 403) {
        noticeUpdateMsg.innerHTML = '<div class="error-msg">Unauthorized</div>';
        return;
      }

      const result = await res.json();
      
      if (result.success) {
        noticeUpdateMsg.innerHTML = `
          <div class="success-msg">
            ‚úÖ ${result.message}<br>
            <small>Notice is now ${data.enabled ? 'ACTIVE' : 'DISABLED'} across all pages</small>
          </div>
        `;
        setTimeout(() => noticeUpdateMsg.innerHTML = '', 5000);
      } else {
        noticeUpdateMsg.innerHTML = `<div class="error-msg">Error: ${result.error}</div>`;
      }
    } catch (err) {
      console.error('Update maintenance notice error:', err);
      noticeUpdateMsg.innerHTML = '<div class="error-msg">Failed to update notice</div>';
    } finally {
      btnUpdateNotice.disabled = false;
      btnUpdateNotice.textContent = 'üíæ Save Notice Settings';
    }
  }
</script>
</body>
</html>
