<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin ‚Äî CEO</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Segoe UI,Arial;margin:0;background:#f4ecd6;color:#333}
    .wrap{max-width:1100px;margin:18px auto;padding:18px}
    .card{background:#fffdf8;border-radius:10px;padding:14px;margin-bottom:12px;border:1px solid #e6dcc0}
    .row{display:flex;gap:10px;align-items:center}
    input,select,button,textarea{padding:8px;border-radius:8px;border:1px solid #ccc}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left;font-size:13px}
    th{background:#e9d8a6}
    .btn{background:#996600;color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
    
/* === Header (Top Bar) === */
.topbar {
  display: flex;
  align-items: center;
  justify-content: center;
  background: #996600;
  color: #fff;
  padding: 12px 16px;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
}

.topbar h2 {
  margin: 0;
  font-size: 16px;
  font-weight: 700;
  letter-spacing: 0.5px;
}
h3 {
  font-size: 15px;
  font-weight: 700;
  margin: 8px 0;
  color: #663300;
}
.btn-back {
  position: absolute;
  left: 13px;
  background: transparent;
  color: #fff;
  border: none;
  font-size: 15px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
}

.btn-back:hover {
  opacity: 0.8;
}

    .table-wrapper {
  width: 100%;
  overflow-x: auto;
}

.table-wrapper table {
  width: 100%;
  min-width: 700px; /* so columns keep shape */
}

@media (max-width: 720px) {
  table th, table td {
    font-size: 13px;
    padding: 6px;
  }
  h3 {
    font-size: 15px;
  }
  .btn-back { 
    front-size:15px;
  }
  
  input, select, button {
    font-size: 13px;
    padding: 6px;
  }
}

  </style>
</head>
  <body>
    <div class="topbar">
  <button class="btn-back" onclick="window.location.href='index.html'">‚Üê Menu</button>
  <h2>Admin Panel</h2>
    </div>
  
    <div class="card">
      <h3>Admin Login</h3>
      <p>Enter your admin token (keeps in session only):</p>
      <div class="row">
        <input id="admToken" placeholder="admin token" style="flex:1" />
        <button id="btnLogin" class="btn">Login</button>
        <button id="btnLogout" style="display:none">Logout</button>
      </div>
      <p id="loginMsg" style="color:#a00"></p>
    </div>

    <div class="card" id="adminPanel" style="display:none">
      <h3>Orders (Latest)</h3>
      <div class="row" style="margin-bottom:8px">
        <input id="filterPhone" placeholder="Filter by phone (optional)"/>
        <button id="btnLoad" class="btn">Load</button>
      </div>

      <div class="table-wrapper">
  <div id="ordersHolder"></div>
      </div>
    </div>
  </div>
<!-- üîß Update Product (Stock / Price) -->
<div class="card" id="updateProductSection" style="display:none">
  <h3>Update Product</h3>

  <div class="form-grid">
    <label>Product:</label>
    <select id="prodSelect">
      <option value="">-- Select Product --</option>
    </select>

    <label>Current Price:</label>
    <input type="number" id="currPrice" step="0.01" readonly />

    <label>Current Stock:</label>
    <input type="number" id="currStock" readonly />

    <label>New Price (optional):</label>
    <input type="number" id="newPrice" step="0.01" placeholder="Enter new price" />

    <label>New Stock (optional):</label>
    <input type="number" id="newStock" placeholder="Enter new stock" />

    <button id="btnUpdateProduct" class="btn">Update Product</button>
  </div>

  <div id="updateResult" style="margin-top:8px;font-size:13px"></div>
</div>
<script>
const API = '/api/admin/orders';

function token() { return sessionStorage.getItem('ADMIN_TOKEN') || ''; }
function setToken(t){ sessionStorage.setItem('ADMIN_TOKEN', t); }
function clearToken(){ sessionStorage.removeItem('ADMIN_TOKEN'); }

document.getElementById('btnLogin').addEventListener('click', async ()=>{
  const v = document.getElementById('admToken').value.trim();
  if(!v){ alert('Enter token'); return; }
  // quick validation: try to fetch 1 order
  try {
    const r = await fetch(API, { headers: { 'x-admin-token': v }});
    if (r.status === 403) throw new Error('Unauthorized');
    const data = await r.json();
    // success
    setToken(v);
    showPanel();
  } catch (err) {
    document.getElementById('loginMsg').textContent = 'Invalid token or server error';
    console.error(err);
  }
});

document.getElementById('btnLogout').addEventListener('click', ()=>{
  clearToken();
  location.reload();
});

function showPanel(){
  document.getElementById('adminPanel').style.display = 'block';
  document.getElementById('updateProductSection').style.display = 'block'; // üëà show product update
  document.getElementById('btnLogout').style.display = 'inline-block';
  document.getElementById('btnLogin').style.display = 'none';
  document.getElementById('admToken').style.display = 'none';
  loadOrders();
  loadProducts();
}

document.getElementById('btnLoad').addEventListener('click', loadOrders);

async function loadOrders(){
  const phone = document.getElementById('filterPhone').value.trim();
  const hdrs = { 'x-admin-token': token() };
  const q = phone ? `?phone=${encodeURIComponent(phone)}` : '';
  const res = await fetch(API + q, { headers: hdrs });
  if (res.status === 403) { alert('Unauthorized - please login again'); clearToken(); return; }
  const orders = await res.json();
  renderOrders(orders);
}

function renderOrders(orders){
  const h = document.getElementById('ordersHolder');
  if(!orders || orders.length===0){ h.innerHTML = '<p>No orders</p>'; return; }
  let html = '<table><thead><tr><th>Order</th><th>Products</th><th>Total</th><th>Phone</th><th>Status</th><th>Action</th></tr></thead><tbody>';
  orders.forEach(o=>{
    html += `<tr>
      <td><strong>${o.order_id}</strong><br/><small>${o.created_at || ''}</small></td>
      <td style="max-width:300px">${(o.prod_name||'').replace(/,/g,'<br/>')}</td>
      <td>RM ${parseFloat(o.total_amt||0).toFixed(2)}</td>
      <td>${o.phone||''}</td>
      <td id="status-${o.order_id}">${o.order_status||o.pymt_status||'‚Äî'}</td>
      <td>
        <select id="s-${o.order_id}">
          <option>Pending Payment</option>
          <option>Paid</option>
          <option>Shipped</option>
          <option>Completed</option>
          <option>Cancelled</option>
        </select>
        <br/>
        <input id="courier-${o.order_id}" placeholder="courier" style="width:140px;margin-top:6px" value="${o.courier_name||''}"/>
        <input id="track-${o.order_id}" placeholder="tracking link" style="width:220px;margin-top:6px" value="${o.tracking_link||''}"/>
        <br/>
        <button class="btn" onclick="updateOrder('${o.order_id}')">Save</button>
      </td>
    </tr>`;
  });
  html += '</tbody></table>';
  h.innerHTML = html;

  // set selects to current status
  orders.forEach(o=>{
    const sel = document.getElementById('s-'+o.order_id);
    if(sel && (o.order_status || o.pymt_status)) {
      const val = o.order_status || o.pymt_status;
      try { sel.value = val; } catch(e){}
    }
  });
}

async function updateOrder(order_id){
  const status = document.getElementById('s-'+order_id).value;
  const courier = document.getElementById('courier-'+order_id).value;
  const track = document.getElementById('track-'+order_id).value;
  const body = { order_id, order_status: status, courier_name: courier, tracking_link: track };
  const res = await fetch(API+'/'+encodeURIComponent(order_id), {
    method: 'PUT',
    headers: { 'Content-Type':'application/json', 'x-admin-token': token() },
    body: JSON.stringify(body)
  });
  if (res.status === 403) { alert('Unauthorized'); clearToken(); return; }
  const data = await res.json();
  if (data.success || data.result) {
    document.getElementById('status-'+order_id).textContent = status;
    alert('Updated');
  } else {
    alert('Update failed: ' + (data.error||JSON.stringify(data)));
  }
}

// on load: if token in session, auto show panel
if (sessionStorage.getItem('ADMIN_TOKEN')) showPanel();

  function goMenu() {
  window.location.href = 'menu.html'; // change to your actual menu page path
}
// === Fetch all products for dropdown ===
async function loadProducts() {
  try {
    const res = await fetch('/api/admin/products', {
      headers: { 'x-admin-token': token() }
    });
    if (res.status === 403) { 
      console.warn('Unauthorized loading products'); 
      return; 
    }
    const products = await res.json();
    const select = document.getElementById('prodSelect');
    if (!select) return;
    select.innerHTML = '<option value="">‚Äî Select Product ‚Äî</option>';
    products.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.prod_id;
      opt.textContent = `${p.prod_id} ‚Äî ${p.prod_name}`;
      select.appendChild(opt);
    });
  } catch (err) {
    console.error('Error loading products:', err);
  }
}

document.getElementById('btnRefreshProd').addEventListener('click', loadProducts);

// === When product selected, fetch details ===
document.getElementById('prodSelect').addEventListener('change', async () => {
document.getElementById('prodSelect').addEventListener('change', async () => {
  const id = document.getElementById('prodSelect').value;
  if (!id) {
    // hide/clear UI
    document.getElementById('currPrice').value = '';
    document.getElementById('currStock').value = '';
    return;
  }
  try {
    const res = await fetch(`/api/admin/products/${encodeURIComponent(id)}`, {
      headers: { 'x-admin-token': token() }
    });
    if (res.status === 403) { alert('Unauthorized'); return; }
    const data = await res.json();
    // fill UI (adjust depending whether you're using textContent or input.value)
    document.getElementById('currPrice').value = data.price ?? '';
    document.getElementById('currStock').value = data.stock ?? '';
    document.getElementById('newPrice').value = '';
    document.getElementById('newStock').value = '';
  } catch (err) {
    console.error('Error fetching product detail:', err);
  }
});

// === Update Product (Stock / Price) ===
document.getElementById('btnUpdateProd').addEventListener('click', async () => {
  const prodId = document.getElementById('prodSelect').value;
  const price = document.getElementById('prodPrice').value.trim();
  const stock = document.getElementById('prodStock').value.trim();
  if (!prodId) { 
    alert('Select a product first'); 
    return; 
  }

  const body = {};
  if (price) body.price = parseFloat(price);
  if (stock) body.stock = parseInt(stock);

  try {
    const res = await fetch(`/api/admin/products/${encodeURIComponent(prodId)}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'x-admin-token': token()
      },
      body: JSON.stringify(body)
    });

    const data = await res.json();
    const msg = document.getElementById('updateProdResult');
    if (data.success) {
      msg.textContent = `‚úÖ ${prodId} updated successfully`;
      msg.style.color = '#006600';
      // Refresh current display
      if (price) document.getElementById('currPrice').textContent = parseFloat(price).toFixed(2);
      if (stock) document.getElementById('currStock').textContent = stock;
    } else {
      msg.textContent = '‚ùå Update failed: ' + (data.error || 'Unknown');
      msg.style.color = '#a00';
    }
  } catch (err) {
    console.error('Error updating product:', err);
  }
});
</script>
</body>
          </html>
