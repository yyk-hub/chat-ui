<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Orders - CEO Coffee</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      background: #f4ecd6;
      font-family: Segoe UI, Arial, sans-serif;
      margin: 0;
    }
    .container {
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }
    .header {
      position: sticky;
      top: 0;
      background: #f4ecd6;
      border-bottom: 2px solid #d1c4a1;
      padding: 12px 0;
      text-align: center;
      z-index: 100;
    }
    .header-title {
      color: #996600;
      margin: 0;
      font-size: 22px;
      font-weight: 600;
    }
    .home-btn {
      position: absolute;
      left: 20px;
      top: 12px;
      background: #996600;
      color: white;
      border: none;
      padding: 6px 14px;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .section {
      background: #fffdf8;
      border-radius: 16px;
      padding: 18px;
      margin-top: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    label {
      display: block;
      margin-top: 8px;
      color: #654321;
      font-weight: 500;
      font-size: 14px;
    }
    input, select, textarea {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    button {
      background: #14b47e;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: background 0.2s;
      margin: 4px 2px;
    }
    button:hover { background: #12a16d; }
    button:disabled { background: #aaa; cursor: not-allowed; }
    .edit-btn { background: #996600; }
    .print-btn { background: #14b47e; }
    .save-btn { background: #14b47e; }
    .cancel-btn { background: #d32f2f; }
    .action-cell { white-space: nowrap; text-align: center; }
    .edit-row { display: none; background: #fffbe6; }
    .edit-row.show { display: table-row; }
    .edit-cell { padding: 12px; }
    .edit-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      max-width: 100%;
      overflow: hidden;
    }
    .edit-full { grid-column: 1 / -1; }
    .product-cell {
      cursor: help;
      max-height: 3.6em;
      overflow: hidden;
      position: relative;
    }
    .product-cell.show-all { max-height: none; }
    .show-more { color: #14b47e; text-decoration: none; font-size: 12px; cursor: pointer; }
    .show-more:hover { text-decoration: underline; }
    .table-container { overflow-x: auto; width: 100%; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; table-layout: auto; }
    th, td { padding: 10px 8px; text-align: left; border-bottom: 1px solid #eee; white-space: nowrap; min-width: 70px; }
    th { background: #e9d8a6; color: #654321; font-weight: 600; }
    td { word-break: break-word; }
    .paid { color: #0b8b0b; font-weight: bold; }
    .pending { color: #d32f2f; font-weight: bold; }
    .other { color: #555; font-weight: bold; }
    a.track-link { color: #14b47e; text-decoration: none; font-weight: 500; }
    a.track-link:hover { text-decoration: underline; }
    .loading { text-align: center; color: #996600; font-style: italic; padding: 20px; }
    .no-orders { text-align: center; color: #999; padding: 20px; font-style: italic; }

    /* PRINT STYLES */
    @media print {
      body * { visibility: hidden; }
      .print-area, .print-area * { visibility: visible; }
      .print-area {
        position: absolute;
        left: 0; top: 0;
        width: 100%;
        padding: 20px;
        background: white;
        font-family: Arial, sans-serif;
      }
      .edit-btn, .print-btn, .cancel-btn, .save-btn, .edit-row, .header, .section:not(.print-area), .action-cell { display: none !important; }
    }

    @media (max-width: 600px) {
      .container { padding: 10px; }
      table { font-size: 12px; }
      th, td { padding: 6px 4px; min-width: 60px; }
      .edit-grid { grid-template-columns: 1fr; gap: 8px; }
      .action-cell button { font-size: 11px; padding: 5px 8px; margin: 2px; }
      input, select, textarea { font-size: 13px; padding: 6px; }
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="index.html" class="home-btn">Home</a>
    <h2 class="header-title">My Orders</h2>
  </div>
  <div class="container">
    <!-- Search Form -->
    <div class="section">
      <label>Phone Number <span style="color:#d32f2f;">*</span></label>
      <input type="text" id="custPhone" placeholder="e.g. 0123456789">
      <button id="loadBtn" onclick="loadOrders()">View My Orders</button>
    </div>
    <!-- Results -->
    <div id="ordersList" class="section" style="display:none;">
      <h3 style="margin-top:0; color:#996600;">Order History</h3>
      <div id="loadingMsg" class="loading" style="display:none;">Loading your orders...</div>
      <div class="table-container">
        <table id="ordersTable">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Product</th>
              <th>Total</th>
              <th>Courier</th>
              <th>Track</th>
              <th>Status</th>
              <th>Date</th>
              <th class="action-cell">Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const BACKEND_URL = "https://chat-ui-30l.pages.dev";

    function formatDate(isoString) {
      if (!isoString) return '-';
      try {
        const d = new Date(isoString);
        if (isNaN(d.getTime())) return '-';
        return d.toLocaleDateString('en-MY', { day: 'numeric', month: 'short', year: 'numeric' }) + ', ' +
               d.toLocaleTimeString('en-MY', { hour: 'numeric', minute: '2-digit' });
      } catch { return '-'; }
    }

    function formatProductList(prodName, orderId) {
      if (!prodName) return '-';
      const items = prodName.split(", ").map(p => p.trim()).filter(p => p);
      if (items.length === 0) return '-';
      const fullText = items.join(", ");
      const displayItems = items.slice(0, 2);
      const displayText = displayItems.join("<br>");
      const showMore = items.length > 2 ? `<br><a class="show-more" onclick="toggleProducts('${orderId}')">Show More</a>` : '';
      return `<span class="product-cell" title="${fullText}" id="products-${orderId}">${displayText}${showMore}</span>`;
    }

    function toggleProducts(orderId) {
      const cell = document.getElementById(`products-${orderId}`);
      if (!cell) return;
      const fullText = cell.getAttribute("title").split(", ").map(p => p.trim()).join("<br>");
      if (cell.classList.contains("show-all")) {
        cell.innerHTML = formatProductList(cell.getAttribute("title"), orderId);
        cell.classList.remove("show-all");
      } else {
        cell.innerHTML = `${fullText}<br><a class="show-more" onclick="toggleProducts('${orderId}')">Show Less</a>`;
        cell.classList.add("show-all");
      }
    }

    function showEditRow(orderId) {
      const editRow = document.getElementById(`edit-${orderId}`);
      if (editRow) editRow.classList.add("show");
    }

    function hideEditRow(orderId) {
      const editRow = document.getElementById(`edit-${orderId}`);
      if (editRow) editRow.classList.remove("show");
    }

    async function saveEdit(orderId) {
      const payload = {
        cus_name: document.getElementById(`name-${orderId}`).value.trim(),
        cus_address: document.getElementById(`address-${orderId}`).value.trim(),
        postcode: document.getElementById(`postcode-${orderId}`).value.trim(),
        state_to: document.getElementById(`state-${orderId}`).value,
        shipping_method: document.getElementById(`shipping-${orderId}`).value === "pickup" ? "Self Pickup" :
                         document.getElementById(`shipping-${orderId}`).value === "express" ? "Express Free" : "Standard Courier"
      };

      try {
        const res = await fetch(`${BACKEND_URL}/api/orders/${orderId}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        // Read response safely
        const text = await res.text();
        let data;
        try {
          data = text ? JSON.parse(text) : {};
        } catch {
          throw new Error("Invalid response from server");
        }

        if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);
        alert("Delivery details updated!");
        hideEditRow(orderId);
        loadOrders();
      } catch (err) {
        alert("Save failed: " + err.message);
      }
    }

    function printOrder(orderId, phone) {
      const printArea = document.getElementById(`print-${orderId}`);
      if (!printArea) return;
      let content = printArea.innerHTML;
      content = content.replace(/\{PHONE\}/g, phone || 'Not provided');
      printArea.innerHTML = content;
      printArea.style.display = 'block';
      window.print();
      printArea.style.display = 'none';
    }

    async function loadOrders() {
      const phone = document.getElementById('custPhone').value.trim();
      if (!phone) return alert('Please enter your phone number.');

      const btn = document.getElementById('loadBtn');
      const list = document.getElementById('ordersList');
      const loading = document.getElementById('loadingMsg');
      const tbody = document.querySelector('#ordersTable tbody');

      btn.disabled = true;
      btn.textContent = "Loading...";
      list.style.display = 'block';
      loading.style.display = 'block';
      tbody.innerHTML = '';

      try {
        const res = await fetch(`${BACKEND_URL}/api/orders?phone=${encodeURIComponent(phone)}`, {
          headers: { 'Accept': 'application/json' }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const text = await res.text();
        let orders;
        try {
          orders = text ? JSON.parse(text) : [];
        } catch {
          throw new Error("Invalid JSON from server");
        }
        if (!Array.isArray(orders)) throw new Error('Invalid response');
        loading.style.display = 'none';

        if (orders.length === 0) {
          tbody.innerHTML = `<tr><td colspan="8" class="no-orders">No orders found.</td></tr>`;
          return;
        }

        orders.forEach(o => {
          const order = {
            order_id: o.order_id || 'Unknown',
            prod_name: o.prod_name || '-',
            total_amt: parseFloat(o.total_amt) || 0,
            shipping_cost: parseFloat(o.shipping_cost) || 0,
            courier_name: o.courier_name || '-',
            tracking_link: o.tracking_link || '',
            order_status: o.order_status || 'Unknown',
            created_at: o.created_at || '',
            cus_name: o.cus_name || '',
            cus_address: o.cus_address || '',
            postcode: o.postcode || '',
            state_to: o.state_to || '',
            shipping_method: o.shipping_method || '',
            phone: o.phone || phone
          };

          const canEdit = order.order_status === "Pending Payment";
          const subTotal = (order.total_amt - order.shipping_cost).toFixed(2);

          const row = document.createElement('tr');
          row.innerHTML = `
            <td><strong>${order.order_id}</strong></td>
            <td>${formatProductList(order.prod_name, order.order_id)}</td>
            <td><strong>RM ${order.total_amt.toFixed(2)}</strong></td>
            <td>${order.courier_name}</td>
            <td>${order.tracking_link ? `<a href="${order.tracking_link}" target="_blank" class="track-link">Track</a>` : '-'}</td>
            <td class="${order.order_status === 'Paid' ? 'paid' : order.order_status === 'Pending Payment' ? 'pending' : 'other'}">${order.order_status}</td>
            <td>${formatDate(order.created_at)}</td>
            <td class="action-cell">
              ${canEdit ? `<button class="edit-btn" onclick="showEditRow('${order.order_id}')">Edit</button>` : ''}
              <button class="print-btn" onclick="printOrder('${order.order_id}', '${order.phone}')">Print</button>
            </td>
          `;
          tbody.appendChild(row);

          // Print Area
          const printArea = document.createElement('div');
          printArea.id = `print-${order.order_id}`;
          printArea.className = 'print-area';
          printArea.style.display = 'none';
          printArea.innerHTML = `
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding:20px;">
              <h2 style="text-align:center; color:#996600; margin-bottom:10px;">CEO Coffee - Order Receipt</h2>
              <p style="text-align:center; font-size:12px; color:#666; margin-top:0;">${formatDate(order.created_at)}</p>
              
              <table style="width:100%; margin-bottom:15px; font-size:14px;">
                <tr><td><strong>Order ID:</strong></td><td>${order.order_id}</td></tr>
                <tr><td><strong>Customer:</strong></td><td>${order.cus_name}</td></tr>
                <tr><td><strong>Phone:</strong></td><td>{PHONE}</td></tr>
              </table>

              <p style="margin:10px 0;"><strong>Delivery Address:</strong><br>
                ${order.cus_address}<br>${order.postcode}, ${order.state_to}
              </p>

              <p style="margin:10px 0;"><strong>Shipping Method:</strong> ${order.shipping_method}</p>

              <hr style="border:0; border-top:1px dashed #ccc; margin:15px 0;">

              <table style="width:100%; font-size:15px;">
                <tr>
                  <td><strong>Products:</strong></td>
                  <td style="text-align:right;">${order.prod_name.replace(/, /g, '<br>')}</td>
                </tr>
                <tr>
                  <td>Sub-total</td>
                  <td style="text-align:right;">RM ${subTotal}</td>
                </tr>
                <tr>
                  <td>Shipping Cost</td>
                  <td style="text-align:right; color:#14b47e;">RM ${order.shipping_cost.toFixed(2)}</td>
                </tr>
                <tr style="border-top:2px solid #996600; font-weight:bold; font-size:16px;">
                  <td>Total Amount</td>
                  <td style="text-align:right; color:#996600;">RM ${order.total_amt.toFixed(2)}</td>
                </tr>
              </table>

              <hr style="border:0; border-top:1px dashed #ccc; margin:15px 0;">

              <p style="margin:10px 0;">
                <strong>Status:</strong> 
                <span style="color:${order.order_status === 'Paid' ? '#0b8b0b' : '#d32f2f'}">
                  ${order.order_status}
                </span>
              </p>

              ${order.tracking_link ? 
                `<p style="margin:10px 0;"><strong>Tracking:</strong> <a href="${order.tracking_link}" style="color:#14b47e; text-decoration:none;">Click to Track</a></p>` 
                : ''}

              <div style="margin-top:30px; text-align:center; font-size:12px; color:#666; line-height:1.5;">
                <p>Thank you for your order!</p>
                <p>Need help? Send receipt via WhatsApp at <a href="index.html#whatsapp" style="color:#14b47e;">Homepage</a></p>
              </div>
            </div>
          `;
          document.body.appendChild(printArea);

          // Edit Row (Compact Grid)
          if (canEdit) {
            const editRow = document.createElement('tr');
            editRow.id = `edit-${order.order_id}`;
            editRow.className = "edit-row";
            editRow.innerHTML = `
              <td colspan="8" class="edit-cell">
                <div class="edit-grid">
                  <div>
                    <label>Name</label>
                    <input type="text" id="name-${order.order_id}" value="${order.cus_name}">
                  </div>
                  <div>
                    <label>Postcode</label>
                    <input type="text" id="postcode-${order.order_id}" value="${order.postcode}">
                  </div>
                  <div class="edit-full">
                    <label>Address</label>
                    <textarea id="address-${order.order_id}" rows="2">${order.cus_address}</textarea>
                  </div>
                  <div>
                    <label>State</label>
                    <select id="state-${order.order_id}">
                      <option value="Kuala Lumpur" ${order.state_to === "Kuala Lumpur" ? "selected" : ""}>Kuala Lumpur</option>
                      <option value="Sabah" ${order.state_to === "Sabah" ? "selected" : ""}>Sabah</option>
                      <option value="Sarawak" ${order.state_to === "Sarawak" ? "selected" : ""}>Sarawak</option>
                      <option value="Penang" ${order.state_to === "Penang" ? "selected" : ""}>Penang</option>
                      <option value="Johor" ${order.state_to === "Johor" ? "selected" : ""}>Johor</option>
                      <option value="West Malaysia" ${order.state_to === "West Malaysia" ? "selected" : ""}>West Malaysia (Other)</option>
                    </select>
                  </div>
                  <div>
                    <label>Shipping</label>
                    <select id="shipping-${order.order_id}">
                      <option value="courier" ${order.shipping_method.includes("Courier") ? "selected" : ""}>Standard Courier</option>
                      <option value="express" ${order.shipping_method.includes("Express") ? "selected" : ""}>Express Free Shipping</option>
                      <option value="pickup" ${order.shipping_method.includes("Pickup") ? "selected" : ""}>Self Pickup</option>
                    </select>
                  </div>
                  <div class="edit-full" style="text-align:right; margin-top:8px;">
                    <button class="cancel-btn" onclick="hideEditRow('${order.order_id}')">Cancel</button>
                    <button class="save-btn" onclick="saveEdit('${order.order_id}')">Save</button>
                  </div>
                </div>
              </td>
            `;
            tbody.appendChild(editRow);
          }
        });

      } catch (err) {
        console.error(err);
        loading.style.display = 'none';
        tbody.innerHTML = `<tr><td colspan="8" style="color:red; text-align:center;">Error: ${err.message}</td></tr>`;
      } finally {
        btn.disabled = false;
        btn.textContent = "View My Orders";
      }
    }
  </script>
</body>
</html>
