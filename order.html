<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CEO - My Orders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <meta property="pi:app" content='{"name":"CEO Shop","description":"Premium health and wellness products","image":"https://ceo-9xi.pages.dev/img/logo.jpg"}'>
  <style>
    body {
      background: #f4ecd6;
      font-family: Segoe UI, Arial, sans-serif;
      margin: 0;
    }
    .container {
      max-width: 1100px;
      margin: auto;
      padding: 15px;
    }
    .header {
      position: sticky;
      top: 0;
      background: #f4ecd6;
      border-bottom: 2px solid #d1c4a1;
      padding: 12px 0;
      text-align: center;
      z-index: 100;
    }
    .header-title {
      color: #996600;
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    .home-btn {
      position: absolute;
      left: 15px;
      top: 12px;
      background: #996600;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .section {
      background: #fffdf8;
      border-radius: 16px;
      padding: 16px;
      margin-top: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    label {
      display: block;
      margin-top: 8px;
      color: #654321;
      font-weight: 500;
      font-size: 14px;
    }
    input, select, textarea {
      width: 100%;
      padding: 9px;
      border-radius: 8px;
      border: 1px solid #ccc;
      margin-top: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    button {
      background: #14b47e;
      color: white;
      border: none;
      padding: 7px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      margin: 3px;
      min-width: 70px;
    }
    button:hover { background: #12a16d; }
    button:disabled { background: #aaa; cursor: not-allowed; }
    .edit-btn { background: #996600; }
    .print-btn { background: #14b47e; }
    .copy-btn { background: #996600; }
    .save-btn { background: #14b47e; }
    .cancel-btn { background: #d32f2f; }
    .action-cell { white-space: nowrap; text-align: center; }
    .edit-row { display: none; background: #fffbe6; }
    .edit-row.show { display: table-row; }
    .edit-cell { padding: 14px; }
    .edit-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-size: 13px;
    }
    .edit-full { grid-column: 1 / -1; }
    .product-cell {
      max-height: 3.6em;
      overflow: hidden;
      position: relative;
    }
    .product-cell.show-all { max-height: none; }
    .show-more { color: #14b47e; font-size: 11px; cursor: pointer; }
    .show-more:hover { text-decoration: underline; }
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      width: 100%;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 13px;
      min-width: 700px;
    }
    th, td {
      padding: 8px 6px;
      text-align: left;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
      min-width: 70px;
    }
    th { background: #e9d8a6; color: #654321; font-weight: 600; font-size: 12px; }
    td { word-break: break-word; font-size: 13px; }
    .paid { color: #0b8b0b; font-weight: bold; }
    .pending { color: #d32f2f; font-weight: bold; }
    .other { color: #555; font-weight: bold; }
    .pi-payment { color: #14b47e; font-weight: bold; }
    a.track-link { color: #14b47e; text-decoration: none; font-weight: 500; }
    a.track-link:hover { text-decoration: underline; }
    .loading { text-align: center; color: #996600; font-style: italic; padding: 20px; }
    .no-orders { text-align: center; color: #999; padding: 20px; font-style: italic; }
    @media print {
      body * { visibility: hidden; }
      .print-area, .print-area * { visibility: visible; }
      .print-area { position: absolute; left: 0; top: 0; width: 100%; padding: 15px; background: white; }
      .edit-btn, .print-btn, .copy-btn, .cancel-btn, .save-btn, .edit-row, .header, .section:not(.print-area), .action-cell { display: none !important; }
    }
    @media (max-width: 600px) {
      .container { padding: 10px; }
      table { font-size: 11px; min-width: 600px; }
      th, td { padding: 6px 4px; }
      .edit-grid { grid-template-columns: 1fr; }
      .action-cell button { font-size: 10px; padding: 4px 6px; margin: 1px; }
      .header-title { font-size: 18px; }
    }
    .toast {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 14px 18px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 6px 16px rgba(0,0,0,0.25);
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s ease, transform .25s ease;
      z-index: 9999;
    }
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(-8px);
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="index.html" class="home-btn">Home</a>
    <h2 class="header-title">My Orders</h2>
  </div>
  <div id="toast" class="toast" aria-live="polite" aria-atomic="true"></div>
  <div class="container">
    <div class="section">
      <label for="custPhone">Phone Number <span style="color:#d32f2f;">*</span></label>
      <input type="text" id="custPhone" placeholder="e.g. 0123456789">
      <button id="loadBtn" onclick="loadOrders()">View My Orders</button>
    </div>
    <div id="ordersList" class="section" style="display:none;">
      <h3 style="margin-top:0; color:#996600;">Order History</h3>
      <div id="loadingMsg" class="loading" style="display:none;">Loading...</div>
      <div class="table-container">
        <table id="ordersTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Product</th>
              <th>Total</th>
              <th>Courier</th>
              <th>Track</th>
              <th>Status</th>
              <th>Date</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
 
  <div style="text-align:center;margin-top:12px;">
    <button id="loadMoreBtn" style="display:none;" onclick="loadOrders(false)">
      Load More
    </button>
  </div>

  <script>
    const BACKEND_URL = window.location.origin;
    let orderCursor = null;
    let hasMoreOrders = true;
    const PAGE_LIMIT = 10;

    // Your existing functions (showPiPaymentSuccess, formatDate, etc.) remain unchanged
    // ... (keep all your original functions here)

    function showToast(message, duration = 3500) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      clearTimeout(toast._t);
      toast._t = setTimeout(() => toast.classList.remove('show'), duration);
    }

    // Restored original print function with mobile warning
    function printOrder(id, phone) {
      const area = document.getElementById(`print-${id}`);
      if (!area) return showToast("Print content not ready");

      let html = area.innerHTML.replace(/\{PHONE\}/g, phone);

      const printDoc = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>CEO Order - ${id}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 20px; background: white; font-size: 16px; line-height: 1.6; }
            h2 { text-align: center; color: #996600; }
            table { width: 100%; border-collapse: collapse; margin: 15px 0; }
            td { padding: 5px 0; }
            hr { border-top: 1px dashed #ccc; margin: 20px 0; }
            .pi-info { color: #14b47e; font-weight: bold; }
          </style>
        </head>
        <body>${html}</body>
        </html>
      `;

      const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

      if (isMobile) {
        const confirmed = confirm(
          "ðŸ–¨ï¸ Mobile Printing\n\n" +
          "Mobile printing can be unreliable.\n\n" +
          "â€¢ Try 'Save as PDF' in the print preview\n" +
          "â€¢ Or use the ðŸ“‹ Copy button below (recommended)\n\n" +
          "Continue to print preview?"
        );
        if (!confirmed) {
          showToast("Use the ðŸ“‹ Copy button for reliable sharing");
          return;
        }

        const iframe = document.createElement('iframe');
        iframe.style.position = 'fixed';
        iframe.style.width = '0';
        iframe.style.height = '0';
        iframe.style.border = '0';
        document.body.appendChild(iframe);

        iframe.contentDocument.write(printDoc);
        iframe.contentDocument.close();

        setTimeout(() => {
          iframe.contentWindow.focus();
          iframe.contentWindow.print();
          setTimeout(() => document.body.removeChild(iframe), 1000);
        }, 500);
      } else {
        // Desktop print (unchanged)
        const blob = new Blob([printDoc], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        document.body.appendChild(iframe);
        iframe.src = url;
        iframe.onload = () => {
          setTimeout(() => {
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
            setTimeout(() => {
              document.body.removeChild(iframe);
              URL.revokeObjectURL(url);
            }, 2000);
          }, 600);
        };
      }
    }

    // New: Reliable Copy button
    async function copyOrder(id, phone) {
      const area = document.getElementById(`print-${id}`);
      if (!area) return showToast("Details not ready");

      let text = area.innerText || area.textContent;
      text = text.replace(/\{PHONE\}/g, phone).trim();

      try {
        await navigator.clipboard.writeText(text);
        showToast("âœ… Order details copied! Paste into WhatsApp or Notes");
      } catch (err) {
        showToast("Copy failed â€” long-press and select the text manually");
      }
    }

    async function loadOrders(reset = true) {
      // ... (your full original loadOrders function unchanged, only change below)

      // Inside the orders.forEach loop â€” replace the action buttons with:
      row.innerHTML = `
        <td><strong>${order.order_id}</strong></td>
        <td>${formatProductList(order.prod_name, order.order_id)}</td>
        <td>${totalDisplay}</td>
        <td>${order.courier_name}</td>
        <td>${order.tracking_link ? `<a href="${order.tracking_link}" target="_blank" class="track-link">Track</a>` : '-'}</td>
        <td class="${order.order_status === 'Paid' ? 'paid' : order.order_status === 'Pending Payment' ? 'pending' : 'other'}">${order.order_status}</td>
        <td>${formatDate(order.created_at)}</td>
        <td class="action-cell">
          ${canEdit ? `<button class="edit-btn" onclick="event.stopPropagation(); showEdit('${order.order_id}')">Edit</button>` : ''}
          <button class="print-btn" onclick="event.stopPropagation(); printOrder('${order.order_id}', '${order.phone}')">Print</button>
          <button class="copy-btn" onclick="event.stopPropagation(); copyOrder('${order.order_id}', '${order.phone}')">ðŸ“‹ Copy</button>
        </td>
      `;

      // ... rest of your loadOrders remains exactly the same
    }

    // Keep all your other original functions (formatDate, showPiPaymentSuccess, etc.)
  </script>
</body>
</html>
