<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CEO Shop</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f4ecd6;
      --accent:#996600;
      --card:#fffbe6;
      --muted:#5b4636;
      --btn:#14b47e;
      --card-radius:14px;
      --container-max:800px;
    }

    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      font-family:"Segoe UI", Arial, sans-serif;
      color:#3b2f2f;
    }

    /* Slimmer sticky header with 3 items: Home (left), Title (center), Cart (right) */
    .header{
      position:sticky;
      top:0;
      z-index:1000;
      background:var(--bg);
      padding:8px 0;                /* reduced padding for slimmer row */
      border-bottom:2px solid #d1c4a1;
      display:flex;
      align-items:center;
      justify-content:center;
      height:48px;                 /* slimmer height */
      box-sizing:border-box;
    }

    .header .home-btn,
    .header .cart-btn{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      background:var(--accent);
      color:#fff;
      border:0;
      padding:6px 10px;            /* slightly smaller buttons */
      border-radius:8px;
      text-decoration:none;
      font-weight:600;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:14px;
    }
    .header .home-btn{ left:12px; }
    .header .cart-btn{ right:12px; }

    .header-title{
      margin:0;
      color:var(--accent);
      font-size:16px;              /* slightly reduced */
      font-weight:700;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .container{
      max-width:var(--container-max);
      margin:20px auto;            /* a touch tighter to match slimmer header */
      padding:20px;
    }

    .category{
      margin-bottom:24px;
    }

    .category h3{
      margin:0 0 12px;
      color:var(--accent);
      font-size:16px;
      border-bottom:2px solid #e6dcc0;
      padding-bottom:8px;
    }

    /* Each product is a full-width row (100% of .container) */
    .product{
      background:var(--card);
      border-radius:var(--card-radius);
      padding:12px;
      margin:10px 0;
      border:1px solid #e0d5bb;
      box-sizing:border-box;
    }

    /* Two-column layout inside each product: image (left) + content (right) */
    .product-content{
      display:grid;
      grid-template-columns: 110px 1fr; /* slightly smaller image to match compact layout */
      gap:12px;
      align-items:center;
    }

    .product img{
      width:110px;
      height:110px;
      object-fit:cover;
      border-radius:10px;
      border:1px solid #ccc;
      display:block;
      cursor:pointer;
    }

    .product h4{
      margin:0 0 8px 0;
      color:var(--accent);
      font-size:15px;
    }

    .product p{
      margin:6px 0;
      color:var(--muted);
      line-height:1.3;
      font-size:14px;
    }

    .product-meta{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:8px;
    }

    .btn{
      background:var(--btn);
      color:#fff;
      border:0;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
    }
    .btn:disabled{
      background:#bbb;
      cursor:not-allowed;
    }

    /* Small screens: stack image above text (single column) */
    @media (max-width:640px){
      .container{ padding:12px; margin:16px auto; }
      .product-content{ grid-template-columns: 1fr; }
      .product img{ width:100%; height:200px; max-height:300px; }
    }
  </style>
</head>
<body>
  <div class="header" role="banner">
    <a href="index.html" class="home-btn" aria-label="Home">üè† Home</a>
    <h2 class="header-title">‚òï CEO Shop</h2>
    <a href="cart.html" class="cart-btn" aria-label="Cart">üõí Cart (<span id="cart-count">0</span>)</a>
  </div>

  <main class="container" id="main">
    <div id="product-list" aria-live="polite"></div>
  </main>

  <script>
    // Simple cart count updater (works even if cart-utils.js isn't present)
    function updateCartCount(){
      const cart = JSON.parse(localStorage.getItem('cart')||'[]');
      const qty = cart.reduce((s,i)=> s + (i.qty||0), 0);
      const el = document.getElementById('cart-count');
      if(el) el.textContent = qty;
    }

    function addToCart(id, name, price){
      let cart = JSON.parse(localStorage.getItem('cart')||'[]');
      const found = cart.find(it => it.id === id);
      if(found) found.qty = (found.qty || 0) + 1;
      else cart.push({ id, name, price, qty: 1 });
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartCount();
      setTimeout(()=> alert(`‚úÖ Added "${name}" to cart`), 10);
    }

    async function loadProducts(){
      try{
        const res = await fetch('/api/products');
        if(!res.ok) throw new Error('Network response not ok');
        const products = await res.json();
        const productList = document.getElementById('product-list');
        productList.innerHTML = '';

        // Group by category preserving order
        const categories = [...new Set(products.map(p=>p.category))];

        categories.forEach(cat => {
          const section = document.createElement('section');
          section.className = 'category';
          const header = document.createElement('h3');
          header.textContent = cat;
          section.appendChild(header);

          // filter in-stock only
          products.filter(p => p.category === cat && p.stock > 0)
            .forEach(p => {
              const prod = document.createElement('article');
              prod.className = 'product';
              const imgSrc = p.image_url ? p.image_url.replace('.png', '.jpg') : '';
              // Image is now wrapped in a link to the requested menu URL
              prod.innerHTML = `
                <div class="product-content">
                  <a href="https://chat-ui-30l.pages.dev/menu" aria-label="Open menu for ${escapeHtml(p.prod_name)}">
                    <img src="${imgSrc}" alt="${escapeHtml(p.prod_name)}">
                  </a>
                  <div class="product-info">
                    <h4>${escapeHtml(p.prod_name)}</h4>
                    <p>${escapeHtml(p.description || '')}</p>
                    <div class="product-meta">
                      <div><strong>Price:</strong> RM ${Number(p.price).toFixed(2)}</div>
                      <div><strong>Stock:</strong> ${p.stock}</div>
                      <button class="btn" ${p.stock<=0?'disabled':''} onclick="addToCart('${p.prod_id}','${escapeAttr(p.prod_name)}',${Number(p.price)})">Add to Cart</button>
                    </div>
                  </div>
                </div>
              `;
              section.appendChild(prod);
            });

          productList.appendChild(section);
        });

      }catch(err){
        console.error('Failed to load products', err);
        const productList = document.getElementById('product-list');
        productList.innerHTML = '<p style="color:#a00">Failed to load products.</p>';
      }
    }

    // small helpers to avoid breaking HTML when names/descriptions contain quotes
    function escapeHtml(s){
      if(!s && s !== 0) return '';
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }
    function escapeAttr(s){
      // for use inside single-quoted onclick attributes
      if(!s && s !== 0) return '';
      return String(s).replace(/'/g,"\\'");
    }

    // init
    updateCartCount();
    loadProducts();
  </script>
</body>
</html>
