<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pi Test Payment - 1œÄ</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .card {
      background: white;
      max-width: 400px;
      width: 100%;
      border-radius: 20px;
      padding: 40px 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
    }

    .logo {
      font-size: 60px;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 24px;
      color: #1a202c;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #718096;
      font-size: 14px;
      margin-bottom: 30px;
    }

    .amount {
      background: linear-gradient(135deg, #667eea15, #764ba215);
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 25px;
    }

    .amount-value {
      font-size: 48px;
      font-weight: bold;
      color: #667eea;
    }

    .info {
      background: #f7fafc;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      text-align: left;
      font-size: 13px;
      display: none;
    }

    .info.show { display: block; }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .info-row:last-child { border-bottom: none; }

    .info-label {
      color: #718096;
    }

    .info-value {
      color: #1a202c;
      font-weight: 600;
    }

    .btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(102,126,234,0.4);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .result {
      margin-top: 20px;
      padding: 20px;
      border-radius: 12px;
      display: none;
      text-align: center;
    }

    .result.show { display: block; }

    .result.success {
      background: #d1fae5;
      color: #065f46;
    }

    .result.error {
      background: #fee2e2;
      color: #991b1b;
    }

    .result-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }

    .result-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .result-detail {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 8px;
      word-break: break-all;
      line-height: 1.5;
    }

    .order-box {
      background: white;
      border: 2px dashed #10b981;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
    }

    .order-label {
      font-size: 11px;
      text-transform: uppercase;
      opacity: 0.6;
      margin-bottom: 5px;
    }

    .order-id {
      font-size: 14px;
      font-weight: 700;
      font-family: monospace;
    }

    .note {
      margin-top: 20px;
      font-size: 12px;
      color: #718096;
    }

    .debug {
      margin-top: 15px;
      padding: 10px;
      background: #fef3c7;
      border-radius: 8px;
      font-size: 11px;
      color: #92400e;
      text-align: left;
      font-family: monospace;
      white-space: pre-wrap;
      display: none;
    }

    .debug.show { display: block; }
  </style>
</head>
<body>

<div class="card">
  <div class="logo">œÄ</div>
  <h1>Test Payment</h1>
  <p class="subtitle">Send 1œÄ for refund testing</p>

  <div class="amount">
    <div class="amount-value">1 œÄ</div>
  </div>

  <div class="info" id="info">
    <div class="info-row">
      <span class="info-label">User:</span>
      <span class="info-value" id="userInfo">‚Äî</span>
    </div>
    <div class="info-row">
      <span class="info-label">Order ID:</span>
      <span class="info-value" id="orderInfo">‚Äî</span>
    </div>
  </div>

  <button class="btn" id="payBtn" onclick="startPay()">
    üîê Pay with Pi
  </button>

  <div class="result" id="result">
    <div class="result-icon" id="resultIcon"></div>
    <div class="result-title" id="resultTitle"></div>
    <div class="result-detail" id="resultDetail"></div>
    <div class="order-box" id="orderBox" style="display:none;">
      <div class="order-label">Your Order ID for Refund</div>
      <div class="order-id" id="finalOrder"></div>
    </div>
  </div>

  <div class="note">Open in Pi Browser</div>

  <div class="debug" id="debug"></div>
</div>

<script>
  const API = window.location.origin;
  let user = null;
  let orderID = null;
  
  function log(msg) {
    console.log(msg);
    const debug = document.getElementById('debug');
    debug.classList.add('show');
    debug.textContent += msg + '\n';
  }

  function showResult(type, icon, title, detail, showOrder = false) {
    const result = document.getElementById('result');
    result.className = `result show ${type}`;
    document.getElementById('resultIcon').textContent = icon;
    document.getElementById('resultTitle').textContent = title;
    document.getElementById('resultDetail').textContent = detail;
    
    if (showOrder && orderID) {
      document.getElementById('orderBox').style.display = 'block';
      document.getElementById('finalOrder').textContent = orderID;
    }
  }

  function updateBtn(text, disabled = true) {
    const btn = document.getElementById('payBtn');
    btn.textContent = text;
    btn.disabled = disabled;
  }

  async function startPay() {
    const btn = document.getElementById('payBtn');
    btn.disabled = true;

    try {
      log('Step 1: Check Pi SDK');
      
      if (typeof Pi === 'undefined') {
        throw new Error('Pi SDK not loaded. Use Pi Browser!');
      }
      
      log('‚úì Pi SDK found');

      // Initialize
      log('Step 2: Initialize Pi');
      updateBtn('‚è≥ Initializing...');
      
      const isSandbox = window.location.hostname !== 'ceo-9xi.pages.dev';
      log(`Sandbox: ${isSandbox}`);
      
      await Pi.init({ version: "2.0", sandbox: isSandbox });
      log('‚úì Pi initialized');

      // Authenticate
      log('Step 3: Authenticate');
      updateBtn('üîê Authenticating...');
      
      const auth = await Pi.authenticate(['payments', 'wallet_address'], (p) => {
        log('‚ö† Incomplete payment found');
      });
      
      user = auth.user;
      log(`‚úì User: ${user.username || user.uid}`);

      // Show user info
      document.getElementById('info').classList.add('show');
      document.getElementById('userInfo').textContent = `@${user.username || user.uid}`;

      // Generate Order ID
      orderID = `ORD${Date.now()}`;
      document.getElementById('orderInfo').textContent = orderID;
      log(`‚úì Order: ${orderID}`);

      // Create payment
      log('Step 4: Create payment');
      updateBtn('üí≥ Creating payment...');

      let approvalDone = false;
      let completionDone = false;

      Pi.createPayment({
        amount: 1.0,
        memo: `Test-${orderID}`,
        metadata: { order_id: orderID, test: true }
      }, {
        onReadyForServerApproval: async (paymentId) => {
          if (approvalDone) {
            log('‚ö† Approval already done, skipping');
            return;
          }
          approvalDone = true;
          
          log(`Approve: ${paymentId}`);
          updateBtn('‚úÖ Approving...');
          
          await fetch(`${API}/api/pi/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              payment_id: paymentId,
              order_id: orderID,
              user_uid: user.uid,
              username: user.username || 'unknown',
              amount: 1.0
            })
          });
          
          log('‚úì Approved');
        },

        onReadyForServerCompletion: async (paymentId, txid) => {
          if (completionDone) {
            log('‚ö† Completion already done, skipping');
            return;
          }
          completionDone = true;
          
          log(`Complete: ${txid}`);
          updateBtn('üîó Completing...');
          
          await fetch(`${API}/api/pi/complete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              payment_id: paymentId,
              txid: txid,
              order_id: orderID
            })
          });
          
          log('‚úì Payment complete!');
          btn.style.display = 'none';
          
          showResult('success', 'üéâ', 'Payment Success!',
            `TxID: ${txid}\n\nUse this Order ID for refund:`, true);
        },

        onCancel: (paymentId) => {
          log('‚úó Payment cancelled');
          showResult('error', '‚ö†Ô∏è', 'Cancelled', 'Payment was cancelled');
          updateBtn('üîê Pay with Pi', false);
        },

        onError: (error) => {
          log(`‚úó Error: ${error.message}`);
          showResult('error', '‚ùå', 'Payment Failed', error.message);
          updateBtn('üîê Pay with Pi', false);
        }
      });

    } catch (err) {
      log(`‚úó ERROR: ${err.message}`);
      showResult('error', '‚ùå', 'Error', err.message);
      updateBtn('üîê Pay with Pi', false);
    }
  }

  // Test if button works
  log('Page loaded. Click button to start.');
</script>

</body>
</html>