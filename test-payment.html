<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pi Refund Test ‚Äî Send 1œÄ</title>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@400;500&display=swap');

    :root {
      --pi: #7B4FE9;
      --pi-light: #9B77FF;
      --pi-dark: #4A2FA0;
      --gold: #F5C842;
      --bg: #0D0B14;
      --card: #16121F;
      --border: #2A2040;
      --text: #F0EDF9;
      --muted: #7A6F8F;
      --success: #2ECC71;
      --error: #E74C3C;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Syne', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 24px;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(123,79,233,0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(123,79,233,0.05) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
    }

    body::after {
      content: '';
      position: fixed;
      top: -200px;
      left: 50%;
      transform: translateX(-50%);
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, rgba(123,79,233,0.15) 0%, transparent 70%);
      pointer-events: none;
    }

    .container {
      width: 100%;
      max-width: 420px;
      position: relative;
      z-index: 1;
    }

    .header {
      text-align: center;
      margin-bottom: 32px;
    }

    .pi-logo {
      width: 64px;
      height: 64px;
      background: linear-gradient(135deg, var(--pi), var(--pi-light));
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      margin: 0 auto 16px;
      box-shadow: 0 8px 32px rgba(123,79,233,0.4);
      animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-8px); }
    }

    .header h1 {
      font-size: 28px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--text), var(--pi-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .header p {
      color: var(--muted);
      font-size: 14px;
      line-height: 1.5;
    }

    .test-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(245,200,66,0.1);
      border: 1px solid rgba(245,200,66,0.3);
      color: var(--gold);
      padding: 4px 12px;
      border-radius: 100px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 16px;
    }

    .test-badge::before {
      content: '';
      width: 6px;
      height: 6px;
      background: var(--gold);
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.8); }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 28px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(123,79,233,0.5), transparent);
    }

    .amount-display {
      text-align: center;
      padding: 24px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
    }

    .amount-display .label {
      font-size: 11px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .amount-display .amount {
      font-size: 56px;
      font-weight: 800;
      color: var(--pi-light);
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .amount-display .amount span {
      font-size: 28px;
      color: var(--muted);
      font-weight: 400;
    }

    .user-box {
      background: rgba(123,79,233,0.08);
      border: 1px solid rgba(123,79,233,0.2);
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 20px;
      display: none;
      align-items: center;
      gap: 12px;
    }

    .user-box.visible { display: flex; }

    .user-avatar {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--pi), var(--pi-dark));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .user-info .name {
      font-weight: 600;
      font-size: 14px;
    }

    .user-info .uid {
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      margin-top: 2px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      font-size: 13px;
    }

    .info-row:last-child { border-bottom: none; }

    .info-row .key { color: var(--muted); }

    .info-row .value {
      font-family: 'DM Mono', monospace;
      color: var(--text);
      font-size: 12px;
    }

    .info-row .value.highlight { color: var(--pi-light); }

    .pay-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, var(--pi), var(--pi-dark));
      border: none;
      border-radius: 16px;
      color: white;
      font-family: 'Syne', sans-serif;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: all 0.2s;
      letter-spacing: 0.02em;
    }

    .pay-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(123,79,233,0.5);
    }

    .pay-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .status-box {
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      display: none;
      margin-top: 16px;
    }

    .status-box.success {
      display: block;
      background: rgba(46,204,113,0.1);
      border: 1px solid rgba(46,204,113,0.3);
    }

    .status-box.error {
      display: block;
      background: rgba(231,76,60,0.1);
      border: 1px solid rgba(231,76,60,0.3);
    }

    .status-box .status-icon { font-size: 36px; margin-bottom: 8px; }
    .status-box .status-title { font-size: 16px; font-weight: 700; margin-bottom: 6px; }
    .status-box.success .status-title { color: var(--success); }
    .status-box.error .status-title { color: var(--error); }

    .status-box .status-detail {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      word-break: break-all;
      line-height: 1.6;
    }

    .order-id-box {
      background: rgba(46,204,113,0.05);
      border: 1px dashed rgba(46,204,113,0.3);
      border-radius: 10px;
      padding: 10px 14px;
      margin-top: 12px;
      font-family: 'DM Mono', monospace;
      font-size: 12px;
    }

    .order-id-box .oid-label {
      color: var(--muted);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 4px;
    }

    .order-id-box .oid-value {
      color: var(--success);
      font-weight: 500;
    }

    .footer-note {
      text-align: center;
      font-size: 12px;
      color: var(--muted);
      margin-top: 20px;
      line-height: 1.6;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="test-badge">Testnet Mode</div>
    <div class="pi-logo">œÄ</div>
    <h1>Refund Test Payment</h1>
    <p>Send 1œÄ to test the A2U refund system.<br>Your Pi will be refunded automatically.</p>
  </div>

  <div class="card">
    <div class="user-box" id="userBox">
      <div class="user-avatar">üë§</div>
      <div class="user-info">
        <div class="name" id="userName">Loading...</div>
        <div class="uid" id="userUid">...</div>
      </div>
    </div>

    <div class="amount-display">
      <div class="label">Amount to Send</div>
      <div class="amount">1 <span>œÄ</span></div>
    </div>

    <div class="info-row">
      <span class="key">Purpose</span>
      <span class="value highlight">A2U Refund Test</span>
    </div>
    <div class="info-row">
      <span class="key">Network</span>
      <span class="value">Pi Testnet</span>
    </div>
    <div class="info-row">
      <span class="key">Order ID</span>
      <span class="value" id="orderIdDisplay">Will be generated</span>
    </div>
  </div>

  <button class="pay-btn" id="payBtn">
    üîê Authenticate & Pay 1œÄ
  </button>

  <div class="status-box" id="statusBox">
    <div class="status-icon" id="statusIcon">‚úÖ</div>
    <div class="status-title" id="statusTitle">Payment Successful!</div>
    <div class="status-detail" id="statusDetail"></div>
    <div class="order-id-box" id="orderIdBox" style="display:none;">
      <div class="oid-label">Order ID (for admin refund)</div>
      <div class="oid-value" id="finalOrderId"></div>
    </div>
  </div>

  <div class="footer-note">
    Testnet payment for refund testing. Real Pi not spent.
  </div>
</div>

<script>
  const API_BASE = window.location.origin;
  let isInitialized = false;
  let isAuthenticated = false;
  let piUser = null;
  let currentOrderId = null;

  // Initialize Pi SDK on page load
  async function initPi() {
    if (isInitialized) return true;
    
    try {
      console.log('üîÑ Initializing Pi SDK...');
      
      if (typeof Pi === 'undefined') {
        throw new Error('Pi SDK not loaded. Please open in Pi Browser.');
      }

      // Detect environment
      const isSandbox = window.location.hostname === 'chat-ui-30l.pages.dev' ||
                        window.location.hostname.includes('localhost');
      
      await Pi.init({
        version: "2.0",
        sandbox: isSandbox
      });
      
      isInitialized = true;
      console.log('‚úÖ Pi SDK initialized');
      return true;
      
    } catch (err) {
      console.error('‚ùå Pi init error:', err);
      showStatus('error', '‚ùå', 'Initialization Error', 
        'Please open this page in Pi Browser. Regular browsers cannot process Pi payments.');
      return false;
    }
  }

  // Show status
  function showStatus(type, icon, title, detail, orderId = null) {
    const box = document.getElementById('statusBox');
    box.className = `status-box ${type}`;
    document.getElementById('statusIcon').textContent = icon;
    document.getElementById('statusTitle').textContent = title;
    document.getElementById('statusDetail').textContent = detail;

    if (orderId) {
      document.getElementById('orderIdBox').style.display = 'block';
      document.getElementById('finalOrderId').textContent = orderId;
    }
  }

  // Reset button
  function resetButton() {
    const btn = document.getElementById('payBtn');
    btn.disabled = false;
    btn.textContent = 'üîê Authenticate & Pay 1œÄ';
  }

  // Handle incomplete payments
  function onIncompletePaymentFound(payment) {
    console.log('‚ö†Ô∏è Incomplete payment:', payment);
    alert(`‚ö†Ô∏è You have an incomplete payment of ${payment.amount} œÄ. Please complete it in Pi Wallet first.`);
  }

  // Main payment handler
  async function handlePayment() {
    const btn = document.getElementById('payBtn');
    
    try {
      // Step 1: Initialize
      btn.disabled = true;
      btn.textContent = '‚è≥ Initializing...';
      
      const initSuccess = await initPi();
      if (!initSuccess) {
        resetButton();
        return;
      }

      // Step 2: Authenticate
      btn.textContent = 'üîê Authenticating...';
      console.log('üîê Starting authentication...');
      
      const auth = await Pi.authenticate(
        ['payments', 'wallet_address'],
        onIncompletePaymentFound
      );
      
      piUser = auth.user;
      isAuthenticated = true;
      console.log('‚úÖ Authenticated:', piUser.username);

      // Show user info
      document.getElementById('userBox').classList.add('visible');
      document.getElementById('userName').textContent = `@${piUser.username}`;
      document.getElementById('userUid').textContent = piUser.uid;

      // Generate order ID
      currentOrderId = `ORD${Date.now()}`;
      document.getElementById('orderIdDisplay').textContent = currentOrderId;

      // Step 3: Create payment
      btn.textContent = 'üí≥ Creating payment...';
      console.log('üí≥ Creating payment...');

      Pi.createPayment({
        amount: 1.0,
        memo: `Refund Test - ${currentOrderId}`,
        metadata: {
          order_id: currentOrderId,
          test: true,
          purpose: 'a2u_refund_test'
        }
      }, {
        onReadyForServerApproval: async (paymentId) => {
          console.log('üìù Approving:', paymentId);
          btn.textContent = '‚úÖ Approving...';

          const res = await fetch(`${API_BASE}/api/pi/approve`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              payment_id: paymentId,
              order_id: currentOrderId,
              user_uid: piUser.uid,
              username: piUser.username,
              amount: 1.0,
              is_test: true
            })
          });
          console.log('‚úÖ Approved');
        },

        onReadyForServerCompletion: async (paymentId, txid) => {
          console.log('üîó Completing:', txid);
          btn.textContent = 'üîó Completing...';

          const res = await fetch(`${API_BASE}/api/pi/complete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              payment_id: paymentId,
              txid: txid,
              order_id: currentOrderId
            })
          });

          console.log('‚úÖ Payment completed!');
          btn.style.display = 'none';

          showStatus(
            'success',
            'üéâ',
            'Payment Successful!',
            `TxID: ${txid}\n\nAdmin will process your refund using this Order ID.`,
            currentOrderId
          );
        },

        onCancel: (paymentId) => {
          console.log('‚ùå Payment cancelled');
          showStatus('error', '‚ö†Ô∏è', 'Payment Cancelled', 'You cancelled the payment. Try again when ready.');
          resetButton();
        },

        onError: (error) => {
          console.error('‚ùå Payment error:', error);
          let msg = error.message || 'Unknown error';
          if (msg.includes('pending payment')) {
            msg = 'You have a pending payment. Complete or cancel it in Pi Wallet first.';
          }
          showStatus('error', '‚ùå', 'Payment Failed', msg);
          resetButton();
        }
      });

    } catch (err) {
      console.error('‚ùå Error:', err);
      showStatus('error', '‚ùå', 'Error', err.message);
      resetButton();
    }
  }

  // Attach event listener
  document.getElementById('payBtn').addEventListener('click', handlePayment);

  // Auto-initialize when page loads
  window.addEventListener('load', () => {
    setTimeout(() => {
      initPi().catch(err => console.error('Auto-init failed:', err));
    }, 1000);
  });
</script>

</body>
</html>